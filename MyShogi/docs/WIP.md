
# Work In Progress

- このファイルは、既知の問題や作業中の内容を明示することにより、それらに対するバグ報告を防ぐためのものです。


# 修正の予定のない内容

- gpsfish、AVX2用しか存在しない件。
  - SSE2用もAVX2用をコピーしてリネームしたものなのでSSE2環境では動かないです。またNO SSE(32bit版)も用意していないです。
	- gpsfishは動作のテスト用につけているものなので製品版では削除します。
- gpsfishのバナーがQhapaqのバナーを改変したものになっている。
  - 動作テストのために仮で作ったものなのでこうなってます。
	- gpsfishは動作のテスト用につけているものなので製品版では削除します。
- 18コアのPCでも4スレッドしか使われていない。
  - 「将棋神」「カスタム」以外を選択した時は、その棋力を担保するために、Threads = 4 , NodesLimit = XXXが設定されるためです。
- 棋譜の読み上げについて音量がバラバラ…。
  - 私も気になってはいますが、激指の素材そのままです。今回はどうしようもなさげです。
  - 次回(来年？)は音声の収録から私が立ち会います(｀･ω･´)ｂ
- サウンドが鳴らない件
  - Windows Media Playerが使える環境でないと再生されないようです。
  - 詳しくは、[FAQ](faq.md)をご覧ください。


# マスターアップに間に合わなければ、やらない予定のもの(発売日ぐらいのアップデートで対応)

- 形勢グラフ(マスターアップに間に合わなさそうなのでいったん無効化)
  - Mizarさんに作ってもらったのですが、私(やねうらお)がある程度作業しないといけなくて、その作業が間に合いそうにないため。
	- このウィンドウ邪魔なので、検討ウィンドウに埋める予定
  	- マスターアップまでに作業が間に合わないかも。その場合は形勢グラフをなくす。
  - ToolStripの◀▶で局面を移動させた時にその局面での形勢表示にならない。
    - 検討ウィンドウのほうと合わせ、通知のハンドラちゃんと書く。
  - 着手や終局の直後に入れ違いで前の局面の思考が送られてきた時に、次の局面の評価値として記録してしまう。
    - 終局まぎわ、即座に指し手が送られてくるのでこの現象が起きやすい。
    - あとで修正する。
  - このソフトで保存した棋譜を再度読み込んだ時にその評価値が形勢グラフに反映されない。
  - 駒落ちの時、詰まされると落ちる。(tkponさん)
    - 形勢グラフの範囲外にプロットしている模様。

- 連続対局
	- 実装作業あとでやる

- 要望、バグに関して
  - ウィンドウを最大化したならそれを終了時に保存/次回起動時に復元すべき。(tanuki-さん)
  - ponder(「相手の手番で先読み」)が機能していない
    - 未実装。
    - マスターアップに間に合わなさそうなら、この表示(「相手の手番で先読み」)、オフにする。
    - この実装、わりとややこしくて、激指ユーザーとかがターゲットなので必須機能とも言えないので。


# βテストでもらった要望のうち将来的に対応する予定のもの

- 棋譜
  - 本譜のみ書き出し
  - 棋譜のマージ


# ご意見ください

- 棋力の調整について
  - uuunuuunさんの計測に基づいて、node数制限をする形になっています。
  - 1級以下はあまり自然な弱さになっていないのが少し気になりますがGUI側ではどうにもならないです。
  - 評価関数によっても違う？
  - β3で再度調整しなおしました。ご意見ください。
  - β6でプリセットのThreadsを4→2に変更したのでやや棋力が変わっているかも知れません。(最大でR100程度)


# 時間がなくて発売後の対応になりそうなもの

- 発売日は伸びたものの、お盆を挟むのでマスターアップの期日はあまり伸びておらず時間が足りてないので優先度の低いものは後回しにします。
  - 棋譜コメントの表示、編集等
  - 棋譜解析


# 作業中＆修正予定の内容


- 検討ウィンドウ
	- 読み筋表示のところに定跡内容が表示された時にわかりにくい。
		- 改善を考え中
	- 序盤の定跡の局面で読み筋が表示されない
		- gpsfishが定跡の局面で何も返さないため。修正考え中だが、gpsfishは最終的には製品版には含めないので急ぎの問題ではない。
  - 検討中にToolStripの◀▶で局面を移動させた時にその局面での思考が開始されない。
  - 検討ウィンドウで◀▶が正常に動作しない
    - どこかで壊した模様。修正する。
  - 対局開始時に継ぎ盤の局面を初期化したほうが良いのでは。

- 検討エンジンの選択
	- メニューの「対局」のところから検討エンジンを変更できるようにする予定。いまはGPSfishが自動的に選ばれている。

- 詰将棋エンジンの選択
	- 「詰」ボタン(詰将棋機能)、未実装。
	- メニューの「対局」のところから詰将棋エンジンを変更できるようにする予定。

- 修正作業中
  - エンジン同士の対局で「中」を押した時にファイルメニューがアクティブにならないことがある。(masaさん)
  - 棋譜の再生時に表示が乱れる件。(suimonさん)


- インストーラー
	- Mizarさんが作ってくれたので最終、インストーラーつける
  - 最後、engine/gpsfish/ , engine/gpsfish2/ のフォルダを除外する。


# 改修履歴


- β6からβ7で改修した点[2018/08/03]
  - メニュー　→　対局　→「検討モード」を「検討エンジン設定」に変更。
    - 「検討エンジン設定」を選ぶか、「検」討ボタンを押して検討エンジンが設定されていないときに検討エンジン設定ダイアログを出すようにした。
    - 詰検討についても同様。
  - エンジン選択と詳細設定のダイアログもメインウィンドウに対してセンタリングする。
  - 「将棋神」のプリセットで、棋力に直接影響しそうなところに関して値を設定する。(NodesLimit = 0 , DepthLimit = 0 , MultiPv = 1など)
  - 「九段」～「10級」も DepthLimit = 0 , MultiPv = 1 を設定しておく。
  - エンジンの詳細設定で"ConsiderationMode"をtrueにしたときに "PvInterval"の設定値が無視される件(masaさん)
    - 設定のところに説明文追加
  - メインウィンドウの表示位置、前回起動時のものを保存するように。(まふさん)
    - 修正案(kumaさん)
      - 採用させていただきました。
  - 棋譜ウィンドウの横幅の設定、メニューの「表示」のところから「ウィンドウ」のところに移動。
  - 「将棋神」「カスタム」のところにCPU負荷の件を追記。
  - 棋譜判定の改善 #30 (tibigameさんのプルリク)
    将棋所、ShogiGUIからの局面コピーが通るように


- β5からβ6で改修した点[2018/08/02]
  - エンジンがevalの読み込みに失敗したとき、「エンジン初期化中」のダイアログが消えない。(kumaさん)
    - プロセス間通信が切断されたときに、エラーダイアログを表示するように修正。
  - 共通設定からEvalDirを削除した。
  - エンジン初期化のときに"isready"送信前にsetoptionを送信するようにした。
  - メニュー　→　「情報」　→　「操作説明(オンラインマニュアル)」　追加。
  - 検討時の駒移動に対してShogiGUIなどでは駒音がある。(Backgammonさん)
    - デフォルトでつけるようにしました。
    - オンオフをメニューの音声　→　検討時の駒音　でオンオフ出来るようにしました。
    - メニューの音声→「棋譜読み上げ」の表示名を「対局時の棋譜読み上げ」に変更。
  - 棋譜をドラッグ＆ドロップで読み込めるようにして欲しい。(まふさん)
    - 実装しました。
    - 対局中・検討中は貼り付けできないように。また、未保存の棋譜がある時には警告を出すように。
  - メニューのファイルのところ、ショートカットキーのOが２つあったの修正。
  - 棋譜がないときにメニューの「上書き保存」が選択できないように。
  - クリップボードからの棋譜の貼り付け(tibigameさん)
    - 実装しました。
    - 対局中・検討中は貼り付けできないように。また、未保存の棋譜がある時には警告を出すように。
  - 未知の形式の棋譜を読み込んだ時にエラーメッセージを表示するようにした。
  - エンジン設定ダイアログの「次ページ」ボタンが見つけにくい。(田中誠さん)
    - エンジン設定ダイアログの各オプション項目の説明文、わかりにくいのでToolTipで表示するように変更。
    - 個別設定のほう、共通設定に従うのチェックボックスが有効のときもToolTipが表示されるように修正。
  - エンジンのプリセット、Threads 4→2に変更。
    - 物理2コアのPCで4スレッドになるとCPU同士の対局でCPU負荷が100%になり続けるため。
  - CPU負荷100%になるの、初心者向きにはよろしくないのでは。(uuunさん)
    - 激指は、スレッド数をCPUの物理コア数にしているようで、デフォルトではCPU負荷は50%になる。
    - 物理コア数をデフォルト値に変更しました。
    - エンジンオプションのThreadsのところに説明文追記。
  - 検討開始した時に対局者名がエンジン名になってしまうの修正。
  - 検討ボタンを押した時に1度目、エンジン初期化のダイアログが出ない。(masaさん)
    - 出てるような…知らない間に修正された？
  - 検討ウィンドウがメインウィンドウに追従するの、メニュー→ウインドウ→検討ウィンドウのところから設定でオフに出来るようにした。
  - 検討ウィンドウを一度も出していないと検討ウィンドウの再表示が出来ないのを修正。
  - 対局設定でエンジン選択した時にたまにプリセット選ばれない時があるの修正。
    - 修正しました。
  - 対局設定で、CPUとの対局のときにCPU側の対局者名の名前を変更しても次に開くとリセットされている件を修正。
    - 修正しました。
  - 対局開始時、メモリ不足ならキャンセル出来たほうが良いのでは。(48さん)
    - ダイアログ修正しました。
    - キャンセルした時に終局していることを示すため「ありがとうございました。またお願いします。」の音声読み上げ追加。
  - ダイアログ、対局中の終了はwarningのダイアログに変更。
  - 対局者名が途中で切れるため「tanuki-」のSDT5と2018の区別がつかない件。(48さん)
    - 半角換算で16文字まで表示するように。(全角は2文字としてカウント)
  - 思考エンジンのプロセス優先度、下がっていない件。(kuma)
    - 間違ったコードになってました。修正しました。
  - 「メニュー」→「情報」→「よくある質問(FAQ)」追加
    - とりあえずMyShogiのGitHubのFAQのページが開くようにしておいた。
  - サウンドが再生されない環境がある。(tibigameさん他)
    - C#のSystem.Windows.Media.MediaPlayerで再生できない環境がある。
      - 他の再生手段をオプションで選択出来るべきか。
      - 多重再生の出来るMicrosoftがサポートしている現行の技術、これぐらいしかないのだが…。
    - 「Windowsの機能の有効化または無効化」→「メディア機能」→Windows Media Playerのチェックボックスをオンにすると音が出た！(tibigameさん)
    - WindowsMediaPlayerをアンインストールしてから再インストールすると再生されるようになるらしい。(ぐららるさん , うさ親さん)
    - このノウハウ、FAQに書いておく。 


- β4からβ5で改修した点[2018/08/01]
  - ×ボタンで閉じるとき、終了前に終了しますかのダイアログを出したほうが良いのでは。(kumaさん)
    - 対局中の×ボタン、棋譜が未保存の時の×ボタンに対しては警告を出すようにしました。
  - エラーならエラー、警告なら警告用のメッセージボックスを用いるようにする。
  - BookOnTheFlyのオプションに説明文追記。
  - 定跡 yaneura_book2.db それらしきものを発掘してきた。
	- 定跡を変更した時にエンジンオプションをどう設定すれば良いのか不明瞭。
		- 定跡周りのオプション設定の説明文、追加。
  - AutoHashの割合、80%→70%にデフォルト値を変更。AutoHashの説明文追加。
  - 対局設定のダイアログの各コントロールにTooltipで説明文追加。
  - 対局設定ダイアログに入玉条件の設定追加
  - エンジンオプション設定をしている時に対局ウィンドウの操作が出来ないようにする。(まふさん)
    - ModalDialogに変更しました。
  - 対局設定でエンジンが選択されていない状態で詳細設定ボタンが押すと落ちる。(masaさん)
    - ModalDialogに変更しました。
  - 対局設定で先後入替えた時に選択していたプリセットが入れ替わらない件。(masaさん)
    - 修正しました。
  - 対局設定で、同種エンジンを選択している時に、「二級」・「初段」のようにそれぞれ異なるプリセットを選択して
    ダイアログを閉じて、再度対局設定を開いた時に、その値が復元されていなかったの修正。
  - 32bit環境でメモリ割り当てに失敗する件。(うさ親さん)
    - エンジン本体の見積もりが小さすぎるようだ。
    - 各エンジンのWorkingMemory を 30から200に変更。
  - 32bit環境でThreadsが出てない件。(うさ親さん)
    - 各エンジン、ビルドしなおし。スレッドあたりのstack 100MB→25MBに変更。スレッド数×25MBを消費するとして計算しなおす。
  - NO SSEのエンジン、EvalShare機能なしでコンパイルしてあったのをEvalShare機能ありでコンパイルしなおす。
  - 検討ウィンドウ、lowerboundが++、upperboundが--。いまは逆になっている。(Mizarさん)
    - 修正しました。


- β3からβ4で改修した点
  - 時間無制限の時のコンピュータに渡す思考時間設定していなかった件。(tanuki-さん他)
    - 時間無制限の時はコンピュータ側は1手5秒で指すようにしました。
  - 対局設定の「詳細設定」絡みの操作で例外が出る件。(yoiyoi322さん)
    - 手順難しい。エンジン選択した時にまだ詳細設定ボタンが生きているのがおかしいのかな？
    - エンジン選択中に詳細設定押せなくする。
    - 詳細設定中にエンジン選択ボタンも押せなくする。
  - 対局設定で先後入替えを押した時、CPUのバナーが入れ替わらない。(うさ親さん)
    - 修正しました。
  - 先手5秒/4秒 , 後手5秒/10秒加算　にした時、後手持ち時間使い切ったあと即指しになる。後手の秒読み、エンジンに渡されていない。(masaさん)
    - 秒読みと秒加算の混合ってUSIでは非対応のような気が…。
    - 先手に対してはbyoyomiで渡して、後手に対してはinctimeで渡すようにする。
  - 共通設定のNetworkDelay2のデフォルト値を300に変更。
    - この値、1000以上にしていると秒読み1秒設定の時に即指しになってバグかと思う人がいるといけないので。
  - tanuki-2018の個別設定からEvalShare削除。
    - このエンジン、EvalShareに対応してないので。
  - tanuki-2018、将棋神でも4スレッドしか使っていない件。(48さん)
    - EvalShareのオプション持ってないのに"engine_options.txt"で無理やり生やして
      Threadsのオプションを上書きしてしまっていた。(調査協力、うさ親さん)
    - 修正しました。


- β2からβ3で改修した点
  - 棋譜ウィンドウの横幅を変更できるように。(48さん)
    - メニューの「表示」→「棋譜ウインドウの横幅」を追加。
  - Ponder設定、とりま、未実装なので非表示にしておく。
    - マスターアップに間に合わなさそうなので…。
  - 対局設定で先後入替えを押した時、後手の時間設定を個別にするがオフの時でも時間設定グループがアクティブになる。(masaさん)
    - 修正しました。
  - エンジンの基本優先度下げたほうが良いのでは。(masaさん)
    - AMD-A9 2コアで、これを下げておかないとCPUを使い切っている状況では音声がぶつ切りに。(うさ親さん)
    - デフォルトでプロセス優先度、下げるようにしました。
  - 形勢グラフ、デバッグ＆修正が間に合わない気がするのでとりま無効化する。
  - 対局中に対局メニューでエンジン変更が出来てしまう。(masaさん)
    - メニュー無効化するように修正。
  - 後手の時に評価値を手番側から見た評価値にする件。
    - メニューの「表示」のところに用意
    - 「後手番のCPUの評価値表示を反転させるか」
    - よく見たら、デフォルトではエンジンが返しているのは自分から見た評価値だった。(´ω｀)
    - 自分から見た評価値をデフォルトとする。(将棋所と同じ)
    - 検討ウインドウに出力している評価値、保存していないので、即時反映は出来なくて、次の出力以降が反転表示される。(いずれなおすかも)
  - レーティング公式、修正。(uuunuuunさん)
    - これにより、5級あたりが少し強くなり、9段あたりは少し弱く調整される模様。
    - NodesLimit = 1000*Exp[(537-Sqrt[537^2 + 4*26.13(975-rate)]/(2*26.13))]
        // Excelの式で言うと　=1000*EXP((537-SQRT(537^2+4*26.13*(975-A1)))/(2*26.13))
    - 九段～十級まで用意した。
  - メニュー項目にアクセスキーを設定する。(kumaさん)
    - 対応しました。
  - 32bit環境で思考エンジンがメモリ割り当てに失敗することがある。(Wandre-sakさん)
    - 32bit環境、1プロセスが2GBまでしか使えないのでHASH割当の計算をするときに空き物理メモリ2GBとして計算すべき。
    - 空き物理メモリを取得する部分で32bit OSでは、空き物理メモリの値を最大でも2048MBとして扱うようにした。
  - LocalGameServerのスレッドで落ちた時に例外の捕捉が出来ていなかったの修正。
    - LocalGameServerのスレッドで落ちた時にもスタックトレースがちゃんと表示されるようになった。


- β1.1からβ2で改修した点
  - 棋譜の名前をつけて保存でデフォルト値を「先手名後手名_YYYYMMDDHHmmss.kif」にして欲しい。(ぐららるさん)
    - 対応しました。
  - 検討ウィンドウの「着順」「R順」も解像度によって少し見切れる件(48さん)
    - ボタン少し大きくしました。
  - tanuki-2018のNO SSE版(32bit環境用)がない。(32bit環境でtanuki-2018が動作しない)
    - SSE4.2版、対局が始まらない。"isready"に対して応答しない。どうやらビルドに失敗している模様。
      - NO SSE版、buildに失敗していて実行ファイル自体が用意できていない。原因調査中。
      - tanuki-2018(NNUEエンジン)、AVX2以外のものを差し替えた。
      - SSE4.2 , SSE4.1 , SSE2 , NO SSE版(32bit版)すべて差し替え。
  - 対局設定、エンジンオプション設定、エンジン選択ダイアログで、低解像度の環境でダイアログの右と下が見切れる可能性がある件。(うさ親さん)
    - β1.1で修正できてなかったので再度修正。AutoScaleDimension = (96F,96F)でしか編集しないように。
    - これで修正できていることを確認。(うさ親さん)
  - BookDirエンジン設定の変なところにあるの修正。
    - エンジンオプションの共通設定にBookDir追加。
    - EvalDirのほうの説明文、追記。
  - エンジンオプションダイアログの「前ページ」「次ページ」が見切れる環境があるらしい。(島田さん)
    - 11pt→9ptに変更。


- β1からβ1.1で改修した点
  - エンジン選択ダイアログの下部ボタンの「次ページ」「前ページ」の文字が見切れている環境がある。(yoiyoiさん)
    - 文字フォントサイズを縮小。「選択」の文字も14→12ptに。
  - 32bit環境用の実行ファイル名が"XXX_no_sse.exe"を読みに行っているが、"XXX_nosse.exe"しか用意されていない件。(うさ親さん)
    - 32bit環境ではどれも実行できない状態でした。(´ω｀)
    - 後者のファイルを読みに行くように修正。
  - 対局設定、エンジンオプション設定、エンジン選択ダイアログで、低解像度の環境でダイアログの右と下が見切れる可能性がある件。(うさ親さん)
    - 一応、強制的にリサイズして修正するコードを書いてみたけど修正されているかは謎。

